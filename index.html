<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <style type="text/css">
      html { height: 100% }
      body { height: 100%; margin: 0; padding: 0 }
      #map-canvas { height: 100% }
    </style>
    <script type="text/javascript"
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCOKEzSU6rQpRYfTqCrMQErJ4dx9CS_7qA">
    </script>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <script type="text/javascript">
      function initialize() {
         // Create an array of styles.
        var styles = [
          {
            "featureType": "water",
            "elementType": "geometry.fill",
            "stylers": [
              { "visibility": "on" },
              { "color": "#D0EDFA" },
              { "lightness": -18 }
            ]
          },{
            "featureType": "road.highway",
            "elementType": "geometry.fill",
            "stylers": [
              { "visibility": "on" },
              { "color": "#FFFFFF" }
            ]
          },{
            "featureType": "road.highway",
            "elementType": "geometry.stroke",
            "stylers": [
              { "visibility": "on" },
              { "color": "#E2E2E2" }
            ]
          },{
            "featureType": "poi",
            "elementType": "geometry.fill",
            "stylers": [
              { "color": "#77BC43" },
              { "gamma": 1.84 }
            ]
          },{
            "featureType": "road.highway",
            "elementType": "labels.icon",
            "stylers": [
              { "visibility": "off" }
            ]
          },{
            "featureType": "road.highway",
            "elementType": "labels.text.fill",
            "stylers": [
              { "color": "#808080" }
            ]
          },{
            "featureType": "landscape",
            "stylers": [
              { "visibility": "on" },
              { "hue": "#BABABA" },
              {"lightness" : 55}
            ]
          },{
            "featureType": "poi.business",
            "elementType": "labels",
            "stylers": [
              {"visibility": "off"}
            ]
          }
        ];

        // Create a new StyledMapType object, passing it the array of styles,
        // as well as the name to be displayed on the map type control.
        var styledMap = new google.maps.StyledMapType(styles,
          {name: "Styled Map"});

        // Create a map object, and include the MapTypeId to add
        // to the map type control.
        var mapOptions = {
          zoom: 11,
          center: new google.maps.LatLng(42.87797684287408, -78.69781494140625),
          mapTypeControlOptions: {
            mapTypeIds: [google.maps.MapTypeId.ROADMAP, 'map_style']
          }
        };
        var map = new google.maps.Map(document.getElementById('map-canvas'),
          mapOptions);

        //Associate the styled map with the MapTypeId and set it to display.
        map.mapTypes.set('map_style', styledMap);
        map.setMapTypeId('map_style');
        var route = new google.maps.FusionTablesLayer({
          query: {
            select: 'geometry',
            from: '118jw2UOdSh8eTJl5IKjvxTdW9L7R0wHmd8je9HBz', 
          }
          ,styles: [{
              polylineOptions: {
                strokeColor: '#76A73E',
                strokeWeight: 5
              },
              markerOptions: {
                iconName: 'red_circle'
              }
            }]

        });
        route.setMap(map);

        //get stops
        var points = [];
        var openInfoWindow=null;
        $.ajax({
            url:"https://www.googleapis.com/fusiontables/v1/query?sql=SELECT * FROM 1qsYqCeNpIkGDvh82HV_pG1kKXi0dfgWjn7z31B7u&key=AIzaSyCOKEzSU6rQpRYfTqCrMQErJ4dx9CS_7qA",
            type: "get",
            dataType:"json",
            async: false,
            success: function(data){
              for (var i = 0; i < data.rows.length; i++){
                var latLng = new google.maps.LatLng(data.rows[i][2].geometry.coordinates[1], data.rows[i][2].geometry.coordinates[0]);
                points[data.rows[i][1]] = {
                  desc: data.rows[i][0], 
                  name: data.rows[i][1], 
                  marker: new google.maps.Marker({
                    position: latLng,
                    map: map,
                    title: data.rows[i][1]
                  }),
                  infoWindow: new google.maps.InfoWindow({
                    content: "<strong>"+data.rows[i][1]+"</strong><br>"+data.rows[i][0],
                    position: latLng
                  }),
                  infoWindowOpen: false
                }
                var p = points[data.rows[i][1]];
                var icon = {
                  anchor: new google.maps.Point(8,8), //set anchor to icon height, width
                  url : 'https://cloud.githubusercontent.com/assets/5604723/4096204/27a6ecb2-2fbe-11e4-9e09-a1133d70d7c0.png' //change to local icon when deploying
                };
                p.marker.setIcon(icon);
                google.maps.event.addListener(p.marker, "click", function(e){
                  if(!points[this.getTitle()].infoWindowOpen) {
                    if (openInfoWindow != null)
                      openInfoWindow.close();
                    points[this.getTitle()].infoWindow.open(map, this);
                    openInfoWindow = points[this.getTitle()].infoWindow;
                    points[this.getTitle()].infoWindowOpen = true;
                  }
                  else {
                    points[this.getTitle()].infoWindow.close()
                    points[this.getTitle()].infoWindowOpen = false;
                  }
                });
              }
            }
        });
      }
      google.maps.event.addDomListener(window, 'load', initialize);
    </script>
  </head>
  <body>
    <div id="map-canvas"/>
  </body>
</html>
