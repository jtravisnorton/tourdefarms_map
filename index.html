<!DOCTYPE html>
<html>
<head>
	<title>Dropoff Locations Map | Buffalo, NY</title>
    <link rel="stylesheet" type="text/css" href="static/leaflet/leaflet.css">
    <script src="static/leaflet/leaflet.js" type="text/javascript"></script>
    <script src="http://code.jquery.com/jquery-1.10.2.min.js"></script>
    <script src="static/js/get_points.js" type="text/javascript"></script>
    <script type="text/javascript"
      src="https://maps.googleapis.com/maps/api/js?sensor=false">
    </script>
    <style type="text/css">
    #map {
        height: 790px;
    }

    .count-icon {
    background:lightblue;
    text-align:center;
    vertical-align:middle;
    border:1px solid #000;
    border-radius:20px;
    line-height:40px;
    height: 5px;
    }
    </style>
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">

    <!-- Optional theme -->
    <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap-theme.min.css">

    <!-- Latest compiled and minified JavaScript -->
    <script src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>
</head>

<body>
<form name="address" id="address" target="_self">
<div class="input-group">
  <span class="input-group-addon">find the nearest dropbox</span>
  <input type="text" class="form-control" name="address" placeholder="address or zipcode">
</div>
</form>
<div id="map">
</div>
<script type="text/javascript">
    //set map environment
    var map;
    var zoom_counties = 10;
    var zoom_cities = 12;
    var zoom_points = 13;
    window.onload = function(){
        map = L.map('map');
        L.tileLayer('http://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png', {
                    attribution:
                        '&copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, ' +
                        '<a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Tiles courtesy of <a href="http://hot.openstreetmap.org/" target="_blank">Humanitarian OpenStreetMap Team</a>',
                }).addTo(map);

        //map zoom, drag behavior
        map.on('zoomend', function(e){
            if (map.getZoom() > zoom_counties & map.getZoom() <= zoom_cities){
                map.removeLayer(group_test.county_group);
                map.removeLayer(group_test.point_group)
                map.addLayer(group_test.city_group);
            }
            if (map.getZoom() >= zoom_points){
                map.removeLayer(group_test.city_group);
                map.addLayer(group_test.point_group)
                popInvisiblePoints(group_test, map);
            }
        });
        map.on('drag', function(e){
            if (map.getZoom() > zoom_points){
                popInvisiblePoints(group_test, map);
            }
        });

        //create new layer group
        var group_test = new Group("static/json/esap_pharmacies.geojson", 'test');
        group_test.county_group.addTo(map);
        map.fitBounds(group_test.county_group.getBounds());
        function popInvisiblePoints(group, thismap){
          var bounds = thismap.getBounds();
          for (point in group.pointMap){
            if (!bounds.contains(group.pointMap[point].latlng)){
                map.removeLayer(group.pointMap[point].layer);
            }
            else{
                map.addLayer(group.pointMap[point].layer);
            }
          }
        }
    }
    
    //geocoding address
    $('#address').submit(function () {
        codeAddress();
        return false;
    });
    var address_marker = null;
    var address_buffer = null;
    function codeAddress() {
        var search_address = document.forms["address"]["address"].value
        console.log(search_address);
        var geocoder = new google.maps.Geocoder();
        if (address_marker != null){
            map.removeLayer(address_marker);
            map.removeLayer(address_buffer)
        }
        geocoder.geocode( { 'address': search_address}, function(results, status) {
          console.log(results, status);
          if (status == google.maps.GeocoderStatus.OK) {
            var latlng = L.latLng(results[0].geometry.location.k, results[0].geometry.location.A)
            address_marker = L.marker(latlng);
            address_buffer = L.circle(latlng, 1609.34)
            map.addLayer(address_marker);
            map.addLayer(address_buffer);
            map.setView(address_marker.getLatLng(), zoom_points);
            address_marker.bindPopup(search_address);
            address_marker.openPopup();
          } else {
            alert("Geocode was not successful for the following reason: " + status);
          }
        });
    }
</script>
</body>
</html>