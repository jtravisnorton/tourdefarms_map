<!DOCTYPE html>
<html>
<head>
	<title>Dropoff Locations Map | Buffalo, NY</title>
    <link rel="stylesheet" type="text/css" href="static/leaflet/leaflet.css">
    <link rel="stylesheet" type="text/css" href="static/css/L.Control.Sidebar.css">
    <script src="static/leaflet/leaflet.js" type="text/javascript"></script>
    <script src="http://code.jquery.com/jquery-1.10.2.min.js"></script>
    <script src="static/js/get_points.js" type="text/javascript"></script>
    <script src="static/js/Leaflet.MakiMarkers.js"></script>
    <script type="text/javascript"
      src="https://maps.googleapis.com/maps/api/js?sensor=false">
    </script>
    <script src="static/js/L.Control.Sidebar.js"></script>
    <style type="text/css">
    #map {
        height: 92vh;
        margin-top: 4em;
    }

    .count-icon {
    text-align:center;
    font-size: 18px;
    vertical-align:middle;
    border-radius:20px;
    line-height:40px;
    height: 5px;
    }

    .info {
        max-height: 790px;
        width: 400px;
        padding: 6px 8px;
        font: 14px/16px Arial, Helvetica, sans-serif;
        background: white;
        box-shadow: 0 0 15px rgba(0,0,0,0.2);
        border-radius: 5px;
    }
    .info h4 {
        margin: 0 0 5px;
        color: #777;
    }

    .legend {
        line-height: 18px;
        color: #555;
    }
    .legend i {
        width: 18px;
        /*height: 18px;*/
        float: left;
        margin-right: 8px;
        opacity: 0.7;
        margin-left: 8px;
    }

    .points-table{
        max-height: 700px;
        overflow: scroll;
        padding-top: 1em;
    }

    .near-point-legend {
        cursor: pointer;
    }
    </style>
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">

    <!-- Optional theme -->
    <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap-theme.min.css">

    <!-- Latest compiled and minified JavaScript -->
    <script src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>
</head>

<body>
    <div class="navbar navbar-default navbar-fixed-top" style="background-color: rgba(255, 255, 255, 0);" role="navigation">
        <div class="container-fluid">
            <div class="navbar-header">
              <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>
              <a class="navbar-brand" href="#">Dropbox  <span class="glyphicon glyphicon-info-sign" data-toggle="modal" data-target="#myModal">
                </span></a>
            </div>
            <div class="navbar-collapse collapse">
                <form name="address" id="address" target="_self" class="navbar-form navbar-left"> 
                    <div class="form-group address-search">
                        <a id="address-input"><input type="text" autocomplete="off" class="form-control" name="address" placeholder="address"></a>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <div id="map">
    </div>
    <div class="modal fade" id="opening-dialog" role="dialog" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <h4 class="modal-title" id="myModalLabel">Welcome</h4>
              </div>
              <div class="modal-body">
                <p>What kind of dropbox would you like to find?</p>
                <div class="btn-group btn-group-justified">
                    <div class="btn-group">
                        <button id="drug-dropbox" type="button" class="btn btn-default" >Drug dropbox</button>
                    </div>
                    <div class="btn-group">
                        <button id="needle-dropbox"type="button" class="btn btn-default">Needle Dropbox</button>
                    </div>
                    <div class="btn-group">
                        <button id="other-dropbox" type="button" class="btn btn-default">Other</button>
                    </div>
                </div>
              </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                <h4 class="modal-title" id="myModalLabel">Dropbox</h4>
              </div>
              <div class="modal-body">
                Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.
              </div>
            </div>
        </div>
    </div>
    <div id="legend">
    </div>
<script type="text/javascript">
    //map environmental variables
    var map;
    var zoom_counties = 8;
    var zoom_cities = 10;
    var zoom_points = 12;
    var zoom_max = 14;
    var init_bounds = L.latLngBounds(
        L.latLng(40.59875083395948, -79.23850049516057), 
        L.latLng(44.75896447862758, -73.27685372593069));
    var legend = L.control.sidebar('legend', {
                    position: 'right',
                    closeButton: 'false'
        });
    var zoom_alert = L.control({position: 'topleft'});
    var zoom_alert_added = false;
    zoom_alert.onAdd = function(){
        zoom_alert_added = true;
        var div = L.DomUtil.create('div', "alert alert-warning");
        div.innerHTML = "<strong>Zoom in to see points</strong>";
        return div;
    }
    zoom_alert.onRemove = function(){
        zoom_alert_added = false;
    }
    var address_icon = L.MakiMarkers.icon({icon: "building", color: "#d53e4f", size: "l"});
    var near_points_icon = L.MakiMarkers.icon({icon: "pharmacy", color: "#3288bd", size: "l"});
    
    //load map
    window.onload = function(){
        $('#opening-dialog').modal('show');
        map = L.map('map', {maxZoom:zoom_max});
        L.tileLayer('http://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png', {
                    attribution:
                        '&copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, ' +
                        '<a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Tiles courtesy of <a href="http://hot.openstreetmap.org/" target="_blank">Humanitarian OpenStreetMap Team</a>',
                }).addTo(map);
        map.fitBounds(init_bounds);
        map.addControl(legend);
        
        var counties = null;
        $.ajax({
            url:"static/json/nys_counties.geojson",
            type: "get",
            dataType:"json",
            async: false,
            success: function(data){counties=data}
        });
        counties = L.geoJson(counties, {
            onEachFeature: function (feature, layer) {
                layer.on('click', function(){
                    map.fitBounds(layer.getBounds());
                });
            }
        });
        counties.setStyle({color:'#000', opacity: '1', weight: 3});
        counties.addTo(map);
        if(!zoom_alert_added){map.addControl(zoom_alert);}
        

        //map zoom, drag behavior
        map.on('zoomend', function(e){
            if (map.getZoom() < zoom_cities){
                map.removeLayer(group_test.city_group);
                counties.setStyle({fill:true});
                if(!zoom_alert_added){map.addControl(zoom_alert);}

            }
            if (map.getZoom() > zoom_counties & map.getZoom() <= zoom_cities){
                counties.setStyle({fill:false});
                map.removeLayer(group_test.point_group);
                map.removeLayer(near_layers);
                map.addLayer(group_test.city_group);
                if(!zoom_alert_added){map.addControl(zoom_alert);}
            }
            if (map.getZoom() >= zoom_points){
                if(zoom_alert_added){map.removeControl(zoom_alert);}
                counties.setStyle({fill:false});
                map.removeLayer(group_test.city_group);
                map.addLayer(group_test.point_group);
                map.addLayer(near_layers);
                getVisiblePoints(group_test.pointMap, map);
            }
        });
        map.on('move', function(e){
            if (map.getZoom() >= zoom_points){
                getVisiblePoints(group_test.pointMap, map);
            }
        });
        
        $(".address-search").popover({
            placement: 'bottom',
            html: true,
            content: "Enter your address to find the nearest dropoff location",
            delay: { show: 100, hide: 100 }
        });
        $(".address-search").popover("show");

        var group_test;
        $('#drug-dropbox').click(function(){
            group_test = new Group("static/json/esap_pharmacies.geojson", 'test');
            $('#opening-dialog').modal('hide');
        });

        //create new layer group
        function getVisiblePoints(points, thismap){
          var bounds = thismap.getBounds();
          for (point in points){
            if (!near_layers.hasLayer(points[point].latlng)){
                if (!bounds.contains(points[point].latlng)){
                    map.removeLayer(points[point].layer);
                }
                else{
                    map.addLayer(points[point].layer);
                }
            }
          }
        }

        //geocoding address
        $('#address').submit(function () {
            codeAddress();
            $('.input-group-addon').html("searching");
            return false;
        });
        
        map.on('layeradd', function(){
            $('.input-group-addon').html('<span class="glyphicon glyphicon-search"></span>');
        });
        
        var address_marker = null;
        var address_buffer = null;
        function codeAddress() {
            legend.hide();
            var search_address = document.forms["address"]["address"].value
            var geocoder = new google.maps.Geocoder();
            if (address_marker != null){
                map.removeLayer(address_marker);
            }
            geocoder.geocode( {'address': search_address}, function(results, status) {
                console.log(results);
              if (status == google.maps.GeocoderStatus.OK) {
                var latlng = L.latLng(results[0].geometry.location.k, results[0].geometry.location.A)
                address_marker = L.marker(latlng, {zIndexOffset: 999});
                address_marker.setIcon(address_icon);
                address_buffer = L.circle(latlng, 16093.4);
                map.addLayer(address_marker);
                address_marker.bindPopup("<td><strong>Your address:</strong><br>"+search_address);
                address_marker.openPopup();
                nearestPoints(address_marker, address_buffer, group_test);
              } else {
                alert("Geocode was not successful for the following reason: " + status);
              }
            });
        }
        
        //get closest points
        var near_layers = L.layerGroup();
        function nearestPoints(address_point, buffer, group){
            map.removeLayer(near_layers);
            near_layers = L.layerGroup();
            near_points = [];
            bounds = buffer.getBounds();
            var o = address_point.getLatLng();
            map.panTo(o);
            for (var p in group_test.pointMap){
                var point = group_test.pointMap[p].layer;
                var d = point.getLatLng();
                var distance = d.distanceTo(o);
                var directions_url = "https://www.google.com/maps/dir/"+o.lat+","+o.lng+"/"+d.lat+","+d.lng;
                var feature = point.toGeoJSON();
                point.bindPopup("<td><strong>"+feature.id+"</strong><br>"+feature.properties.street+" "+feature.properties.citystatezip+"<br><a href="+directions_url+" target='_blank'>get directions</a></td>");
                if(distance <= buffer.getRadius()){
                    near_points.push({"name": p, "point": point, "distance": distance, "directions_url": directions_url});
                }
            }
            near_points.sort(function (a, b) {
                if (a.distance > b.distance)
                  return 1;
                if (a.distance < b.distance)
                  return -1;
                // a must be equal to b
                return 0;
            });
            var tbody = document.createElement('tbody');
            if(near_points.length > 10){
                near_points = near_points.slice(0,10);
            }
            var near_points_bounds = null;
            near_points.forEach(function(element, index, array){
                if (near_points_bounds == null){
                    near_points_bounds = L.latLngBounds([element.point.getLatLng(), address_point.getLatLng()]);
                }
                else{
                    near_points_bounds.extend(element.point.getLatLng());
                }
                var line = L.polyline([element.point.getLatLng(), address_point.getLatLng()]);
                near_layers.addLayer(line);
                near_layers.addLayer(element.point);
                element.point.setIcon(near_points_icon);
                element.point.setZIndexOffset(999);
                
                //adds near points to legend
                var tr = document.createElement('tr');
                tr.setAttribute('id', element.name);
                tr.className = 'near-point-legend';
                var feature = element.point.toGeoJSON();
                var rank = index + 1;
                tr.innerHTML = "<td>"+rank+"</td><td><strong>"+feature.id+"</strong><br>"+feature.properties.street+"<br>"+feature.properties.citystatezip+"<br><a href="+element.directions_url+" target='_blank'>get directions</a></td>";
                tr.onmouseover = function(e){
                    p = e.target.parentElement.getAttribute('id');
                    if (typeof group_test.pointMap[p] != 'undefined'){
                        group.pointMap[p].layer.openPopup();
                    }
                }
                tr.addEventListener('click', function(e){
                    p = e.target.parentElement.getAttribute('id');
                    if (typeof group_test.pointMap[p] != 'undefined'){
                        if (!map.getBounds().contains(group_test.pointMap[p].latlng)){
                            map.panTo(address_marker.getLatLng());
                            group_test.pointMap[p].layer.openPopup();
                        }
                        else {
                            group_test.pointMap[p].layer.openPopup();
                        }
                    }
                });

                tbody.appendChild(tr);
            });
            map.addLayer(near_layers);
            map.fitBounds(near_points_bounds, {maxZoom: zoom_max});
            var near_points_div = document.createElement('div');
            near_points_div.className = "points-table";
            near_points_div.innerHTML = '<h4>Nearest dropoff locations</h4>'
            var table = document.createElement("table");
            table.className = "table table-hover";
            table.appendChild(tbody);
            near_points_div.appendChild(table);
            legend.addTo(map);
            $(".points-table").remove();
            $("#legend").append(near_points_div);
            legend.show();
        }
    }

</script>
</body>
</html>
