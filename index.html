<!DOCTYPE html>
<html>
<head>
	<title>Dropoff Locations Map | Buffalo, NY</title>
    <link rel="stylesheet" type="text/css" href="static/leaflet/leaflet.css">
    <script src="static/leaflet/leaflet.js" type="text/javascript"></script>
    <script src="http://code.jquery.com/jquery-1.10.2.min.js"></script>
    <script src="static/js/get_points.js" type="text/javascript"></script>
    <script type="text/javascript"
      src="https://maps.googleapis.com/maps/api/js?sensor=false">
    </script>
    <style type="text/css">
    #map {
        height: 790px;
    }

    .count-icon {
    background:lightblue;
    text-align:center;
    vertical-align:middle;
    border:1px solid #000;
    border-radius:20px;
    line-height:40px;
    height: 5px;
    }

    .info {
        height: 500px;
        width: 400px;
        padding: 6px 8px;
        font: 14px/16px Arial, Helvetica, sans-serif;
        background: white;
        box-shadow: 0 0 15px rgba(0,0,0,0.2);
        border-radius: 5px;
    }
    .info h4 {
        margin: 0 0 5px;
        color: #777;
    }

    .legend {
        line-height: 18px;
        color: #555;
    }
    .legend i {
        width: 18px;
        height: 18px;
        float: left;
        margin-right: 8px;
        opacity: 0.7;
    }
    </style>
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">

    <!-- Optional theme -->
    <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap-theme.min.css">

    <!-- Latest compiled and minified JavaScript -->
    <script src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>
</head>

<body>
     <div class="navbar navbar-default navbar-fixed-top" role="navigation">
      <div class="container-fluid">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="#">Dropbox  <span class="glyphicon glyphicon-info-sign" data-toggle="modal" data-target="#myModal">
            </span></a>
        </div>
        <div class="navbar-collapse collapse">
            
        </div>
      </div>
    </div>
   
    <div id="map">
    </div>
<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
            <h4 class="modal-title" id="myModalLabel">Dropbox</h4>
          </div>
          <div class="modal-body">
            Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.
          </div>
        </div>
    </div>
</div>
<script type="text/javascript">
    //set map environment
    var map;
    var zoom_counties = 10;
    var zoom_cities = 12;
    var zoom_points = 13;
    var legend = L.control({position: 'bottomright'});
    legend.onAdd = function () {
        var div = L.DomUtil.create('div', 'info legend');
        div.innerHTML = '<form name="address" id="address" target="_self"> <div class="input-group"><span class="input-group-addon"><span class="glyphicon glyphicon-search"></span></span><input type="text" class="form-control" name="address" placeholder="enter your address or zipcode"></div></form>';
        return div;
    };
    window.onload = function(){
        map = L.map('map', {zoomControl: false});
        L.tileLayer('http://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png', {
                    attribution:
                        '&copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, ' +
                        '<a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Tiles courtesy of <a href="http://hot.openstreetmap.org/" target="_blank">Humanitarian OpenStreetMap Team</a>',
                }).addTo(map);

        //map zoom, drag behavior
        map.on('zoomend', function(e){
            if (map.getZoom() > zoom_counties & map.getZoom() <= zoom_cities){
                map.removeLayer(group_test.county_group);
                map.removeLayer(group_test.point_group)
                map.addLayer(group_test.city_group);
            }
            if (map.getZoom() >= zoom_points){
                map.removeLayer(group_test.city_group);
                map.addLayer(group_test.point_group)
                popInvisiblePoints(group_test, map);
            }
        });
        map.on('drag', function(e){
            if (map.getZoom() > zoom_points){
                popInvisiblePoints(group_test, map);
            }

        });

        //legend design
        legend.addTo(map);

        //create new layer group
        var group_test = new Group("static/json/esap_pharmacies.geojson", 'test');
        group_test.county_group.addTo(map);
        map.fitBounds(group_test.county_group.getBounds());
        function popInvisiblePoints(group, thismap){
          var bounds = thismap.getBounds();
          for (point in group.pointMap){
            if (!bounds.contains(group.pointMap[point].latlng)){
                map.removeLayer(group.pointMap[point].layer);
            }
            else{
                map.addLayer(group.pointMap[point].layer);
            }
          }
        }

        //geocoding address
        $('#address').submit(function () {
            codeAddress();
            $('.input-group-addon').html("searching");
            return false;
        });
        
        map.on('layeradd', function(){
            $('.input-group-addon').html('<span class="glyphicon glyphicon-search"></span>');
        });
        
        var address_marker = null;
        var address_buffer = null;
        function codeAddress() {
            var search_address = document.forms["address"]["address"].value
            console.log(search_address);
            var geocoder = new google.maps.Geocoder();
            if (address_marker != null){
                map.removeLayer(address_marker);
                map.removeLayer(address_buffer)
            }
            geocoder.geocode( {'address': search_address}, function(results, status) {
              console.log(results, status);
              if (status == google.maps.GeocoderStatus.OK) {
                var latlng = L.latLng(results[0].geometry.location.k, results[0].geometry.location.A)
                address_marker = L.marker(latlng);
                address_buffer = L.circle(latlng, 1609.34)
                map.addLayer(address_marker);
                map.addLayer(address_buffer);
                map.setView(address_marker.getLatLng(), zoom_points);
                address_marker.bindPopup(search_address);
                address_marker.openPopup();
                nearestPoints(address_marker, address_buffer, group_test);
              } else {
                alert("Geocode was not successful for the following reason: " + status);
              }
            });
        }
        
        //get closest points
        function nearestPoints(address_point, buffer, group){
            near_points = [];
            bounds = buffer.getBounds();
            console.log(group.pointMap);
            for (var p in group.pointMap){
                var point = group.pointMap[p];
                if(point.latlng.distanceTo(address_point.getLatLng()) <= buffer.getRadius()){
                    near_points.push({"name": p, "point": point.layer, "distance": point.latlng.distanceTo(address_point.getLatLng())});
                }
            }
            near_points.sort(function (a, b) {
                if (a.distance > b.distance)
                  return 1;
                if (a.distance < b.distance)
                  return -1;
                // a must be equal to b
                return 0;
            });
            console.log(near_points.slice(0, 10));
            var tbody = document.createElement('tbody');
            near_points.forEach(function(element, index, array){
                var dot = L.marker(element.point.getLatLng(),{ 
                              icon: L.divIcon({
                              // specify a class name that we can refer to in styles, as we
                              // do above.
                              className: 'count-icon',
                              // html here defines what goes in the div created for each marker
                              html: index + 1,
                              // and the marker width and height
                              iconSize: [10, 10]
                          })});
                map.addLayer(dot);
                var tr = document.createElement('tr');
                tr.setAttribute('id', element.name);
                tr.innerHTML = "<td>"+element.name+"</td>";
                tr.onmouseover = function(e){
                    p = e.target.parentElement.getAttribute('id');
                    console.log(p);
                    group.pointMap[p].layer.openPopup();
                }
                tbody.appendChild(tr);
            });
            var near_points_div = document.createElement('div');
            near_points_div.className = "points-table";
            var table = document.createElement("table");
            table.className = "table table-hover";
            table.innerHTML = "<thead> <tr> <th>Dropbox location</th> </tr> </thead>"
            table.appendChild(tbody);
            near_points_div.appendChild(table);
            $(".points-table").remove();
            $(".legend").append(near_points_div);
        }
    }

</script>
</body>
</html>
